<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Climate Risk Analyzer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #fff;
      margin: 0;
      text-align: center;
    }
    .search-box { margin: 24px; }
    input {
      padding: 10px;
      border-radius: 8px;
      border: none;
      width: 260px;
      font-size: 1em;
    }
    button {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      background: #00e6ff;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      margin-left: 6px;
    }
    .location-highlight {
      margin: 20px auto 10px auto;
      font-size: 1.2em;
      font-weight: bold;
      background: linear-gradient(90deg,#203a43 60%, #00e6ff33, #2c5364);
      color: #ffec8b;
      padding: 10px 24px;
      border-radius: 13px;
      box-shadow: 0 0 14px #00e6ff66;
      display: inline-block;
      letter-spacing: 1px;
    }
    .cards {
      display: flex;
      justify-content: center;
      gap: 18px;
      margin: 18px auto;
      flex-wrap: wrap;
    }
    .card {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 15px;
      min-width: 140px;
      font-size: 18px;
      margin-bottom: 10px;
      box-shadow: 0 0 18px #00e6ff44;
    }
    #aqiGauge { margin:18px auto 10px auto; }
    #map { width:320px; height:180px; margin:14px auto; border-radius:14px; }
    .tips-list div { margin-bottom:7px; color: #b0f5b2; font-weight:500;}
    header{
      font-size: 2rem;
    }
  </style>
</head>
<body>
  <header>üåç Climate Risk Analyzer</header>
  <div class="search-box">
    <input type="text" id="cityInput" placeholder="Enter city or region"/>
    <button onclick="analyzeCity()">Analyze</button>
    <button onclick="getLocation()">Use My Location üìç</button>
  </div>
  <div id="locationHighlight" class="location-highlight"></div>
  <div class="cards" id="riskCards"></div>
  <canvas id="aqiGauge" width="100" height="150"></canvas>
  <div id="map"></div>
  <div class="tips-list" id="tipsList"></div>

  <!-- Download Report Buttons -->
  <div id="downloadReportBox" style="margin:18px; display:none;">
    <button id="downloadCsvBtn" style="margin-right:8px;">‚¨áÔ∏è Download CSV Report</button>
    <button id="downloadPdfBtn">‚¨áÔ∏è Download PDF Report</button>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let aqiGaugeChart = null, myMap = null;
    window.currentCityForReport = null;

    function analyzeCity() {
      const city = document.getElementById("cityInput").value.trim();
      if (!city) return alert("Enter a city name!");
      fetch(`/get_weather_manual?city=${encodeURIComponent(city)}`)
          .then(res => res.json())
          .then(data => handleResult(data));
    }
    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude, lon = pos.coords.longitude;
          fetch(`/get_weather?lat=${lat}&lon=${lon}`)
              .then(res => res.json())
              .then(data => handleResult(data));
        }, () => alert("Location access denied."));
      } else { alert("Geolocation not supported."); }
    }
    function showMap(lat, lon, aqi) {
      if(myMap) { myMap.remove(); myMap = null; }
      myMap = L.map('map').setView([lat, lon], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(myMap);
      let color = aqi < 51 ? 'green' : (aqi < 101 ? 'yellow' : 'red');
      L.circleMarker([lat, lon], { radius:14, color, fillColor:color, fillOpacity:0.6 }).addTo(myMap)
        .bindPopup('AQI: ' + aqi).openPopup();
    }
    function renderAQIGauge(aqi) {
      let clr = aqi < 51 ? "#00e67c" : (aqi<101?"#ffe066":"#ff4444");
      if(aqiGaugeChart) aqiGaugeChart.destroy();
      aqiGaugeChart = new Chart(document.getElementById("aqiGauge").getContext("2d"), {
        type:"doughnut",
        data:{ datasets:[{data:[aqi, 300-aqi], backgroundColor:[clr, "#222"]}] },
        options:{ cutout:"75%", plugins:{legend:{display:false}} }
      });
      const ctx = document.getElementById("aqiGauge").getContext("2d");
      ctx.font = "22px Segoe UI"; ctx.fillStyle = "#fff";
      ctx.textAlign = "center"; ctx.textBaseline = "middle";
      ctx.fillText(aqi, ctx.canvas.width/2, ctx.canvas.height/2);
    }
    function handleResult(data) {
      document.getElementById("locationHighlight").textContent =
        (data.city ? `üìç Location: ${data.city}` : "üìç Location not available");
      const cardsHtml = `
        <div class="card">üå°Ô∏è Temp: <b>${data.temperature}¬∞C</b></div>
        <div class="card">üíß Humidity: <b>${data.humidity}%</b></div>
        <div class="card">üå´Ô∏è AQI: <b>${data.aqi !== null ? data.aqi : "N/A"}</b></div>
        <div class="card">‚òÅÔ∏è Condition: <b>${data.condition}</b></div>
        <div class="card">‚ö†Ô∏è Risk Level: <b>${data.risk_level}</b></div>
      `;
      document.getElementById("riskCards").innerHTML = cardsHtml;
      renderAQIGauge(data.aqi || 0);
      showMap(data.lat, data.lon, data.aqi||0);
      document.getElementById("tipsList").innerHTML = (data.tips||[]).map(tip => `<div>ü©∫ ${tip}</div>`).join("");
      // Show download buttons and set city for report
      window.currentCityForReport = data.city;
      document.getElementById("downloadReportBox").style.display = "block";
    }

    document.getElementById("downloadCsvBtn").onclick = function() {
      if (!window.currentCityForReport) return alert("Analyze a city first!");
      window.location = `/download_report?city=${encodeURIComponent(window.currentCityForReport)}&format=csv`;
    };
    document.getElementById("downloadPdfBtn").onclick = function() {
      if (!window.currentCityForReport) return alert("Analyze a city first!");
      window.location = `/download_report?city=${encodeURIComponent(window.currentCityForReport)}&format=pdf`;
    };

    window.onload = function() {
      getLocation();
      document.getElementById("downloadReportBox").style.display = "none";
    };
  </script>

  <!-- Chatbot -->
  <div id="chatbotWidget" style="position: fixed; bottom: 20px; right: 20px; width: 300px; background: #1e293b; color: #fff; border-radius: 10px; box-shadow: 0 0 12px #00e6ff88; display: flex; flex-direction: column; max-height: 400px; overflow: hidden; font-family: 'Segoe UI', sans-serif; z-index:999;">
    <div style="background:#00e6ff; color:#000; padding:10px; font-weight:bold; text-align:center;">üí¨ Climate Chatbot</div>
    <div id="chatArea" style="flex:1; padding:10px; overflow-y:auto; font-size:14px;"></div>
    <div style="display:flex; border-top:1px solid #333;">
      <input id="chatInput" type="text" placeholder="Ask me..." style="flex:1; padding:8px; border:none; outline:none;"/>
      <button onclick="sendMessage()" style="background:#00e6ff; border:none; padding:8px 12px; cursor:pointer; font-weight:bold;">‚û§</button>
    </div>
  </div>

  <script>
  function appendMessage(sender, text) {
    const chatArea = document.getElementById("chatArea");
    const msgDiv = document.createElement("div");
    msgDiv.style.margin = "6px 0";
    msgDiv.innerHTML = `<b style="color:${sender==='You'?'#ffec8b':'#00e6ff'}">${sender}:</b> ${text}`;
    chatArea.appendChild(msgDiv);
    chatArea.scrollTop = chatArea.scrollHeight;
  }
  function sendMessage() {
    const input = document.getElementById("chatInput");
    const msg = input.value.trim();
    if (!msg) return;
    appendMessage("You", msg);
    input.value = "";
    fetch("/chatbot", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: msg })
    })
    .then(res => res.json())
    .then(data => appendMessage("Bot", data.reply));
  }
  </script>
</body>
</html>
